name: Executar Pipeline ETL

on:
  workflow_dispatch:  # Permite execução manual
    inputs:
      pipeline_mode:
        description: 'Modo de execução do pipeline'
        required: true
        default: 'full'
        type: choice
        options:
          - full
          - raw
          - silver_gold
  schedule:
    # Executa diariamente às 07:30 (horário de Brasília) = 10:30 UTC
    - cron: '30 10 * * *'
  push:
    branches:
      - main
      - master
    paths:
      - 'main.py'
      - 'src/**'
      - 'config/**'
      - '.github/workflows/run_pipeline.yml'

jobs:
  run-pipeline:
    runs-on: ubuntu-latest
    timeout-minutes: 60  # Timeout de 60 minutos
    
    steps:
      - name: Checkout código
        uses: actions/checkout@v4

      - name: Configurar Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Instalar dependências do sistema
        run: |
          sudo apt-get update
          sudo apt-get install -y default-libmysqlclient-dev pkg-config

      - name: Instalar dependências Python
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Criar diretório de configuração
        run: |
          mkdir -p config

      - name: Configurar credenciais GCP
        env:
          GCP_CREDENTIALS: ${{ secrets.GCP_CREDENTIALS }}
        run: |
          if [ -n "$GCP_CREDENTIALS" ]; then
            echo "$GCP_CREDENTIALS" > config/lille-422512-a12a0a3c757b.json
            echo "Credenciais GCP configuradas"
          else
            echo "Aviso: GCP_CREDENTIALS não configurado. Algumas funcionalidades podem não funcionar."
          fi

      - name: Gerar config.yaml dinamicamente
        env:
          PROJECT_ID: ${{ secrets.PROJECT_ID || 'lille-422512' }}
          PROJECT_NAME: ${{ secrets.PROJECT_NAME || 'lille' }}
          CLOUD: ${{ secrets.CLOUD || 'gcp' }}
          BUCKET_PROJETO: ${{ secrets.BUCKET_PROJETO || 'p94_valoreasy' }}
          BUCKET_RAW: ${{ secrets.BUCKET_RAW || 'bronze' }}
          BUCKET_SILVER: ${{ secrets.BUCKET_SILVER || 'silver' }}
          BUCKET_GOLD: ${{ secrets.BUCKET_GOLD || 'gold' }}
          BUCKET_PROCESSED: ${{ secrets.BUCKET_PROCESSED || 'processed-data' }}
          BUCKET_DW: ${{ secrets.BUCKET_DW || 'dw-data' }}
          EMAIL_ENABLED: ${{ secrets.EMAIL_ENABLED || 'true' }}
          SMTP_SERVER: ${{ secrets.SMTP_SERVER || 'smtp.gmail.com' }}
          SMTP_PORT: ${{ secrets.SMTP_PORT || '587' }}
          SMTP_USER: ${{ secrets.SMTP_USER }}
          SMTP_PASSWORD: ${{ secrets.SMTP_PASSWORD }}
          FROM_EMAIL: ${{ secrets.FROM_EMAIL }}
          TO_EMAILS: ${{ secrets.TO_EMAILS }}
        run: |
          cat > config/config.yaml << EOF
          project-id: ${PROJECT_ID}
          project-name: ${PROJECT_NAME}
          cloud: ${CLOUD}
          credentials-path: config/lille-422512-a12a0a3c757b.json
          bucket-projeto: ${BUCKET_PROJETO}
          bucket-raw: ${BUCKET_RAW}
          bucket-silver: ${BUCKET_SILVER}
          bucket-gold: ${BUCKET_GOLD}
          bucket-processed: ${BUCKET_PROCESSED}
          bucket-dw: ${BUCKET_DW}

          # Configurações específicas para GCS Bronze
          gcs:
            bronze:
              bucket: ${BUCKET_PROJETO}
              folder: ${BUCKET_RAW}
              storage-class: STANDARD
              retention-days: 365
            silver:
              bucket: ${BUCKET_PROJETO}
              folder: ${BUCKET_SILVER}
              storage-class: NEARLINE
              retention-days: 730
            gold:
              bucket: ${BUCKET_PROJETO}
              folder: ${BUCKET_GOLD}
              storage-class: COLDLINE
              retention-days: 1825

          # Configurações de E-mail
          email:
            enabled: ${EMAIL_ENABLED}
            smtp_server: ${SMTP_SERVER}
            smtp_port: ${SMTP_PORT}
            smtp_user: ${SMTP_USER}
            smtp_password: ${SMTP_PASSWORD}
            from_email: ${FROM_EMAIL}
            to_emails:
          EOF
          
          # Adiciona os emails destinatários (pode ter múltiplos separados por vírgula)
          if [ -n "$TO_EMAILS" ]; then
            IFS=',' read -ra EMAILS <<< "$TO_EMAILS"
            for email in "${EMAILS[@]}"; do
              echo "    - ${email}" >> config/config.yaml
            done
          else
            echo "    - rubens@lilleschool.com.br" >> config/config.yaml
            echo "    - llemos@lilleschool.com.br" >> config/config.yaml
          fi
          
          echo "config.yaml gerado com sucesso"
          cat config/config.yaml

      - name: Executar Pipeline
        id: pipeline
        run: |
          # Determina o modo de execução baseado no tipo de evento
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            MODE="${{ github.event.inputs.pipeline_mode }}"
          else
            MODE="full"
          fi
          
          echo "Executando pipeline no modo: $MODE"
          
          case $MODE in
            raw)
              echo "Executando apenas camada RAW..."
              python main.py raw
              ;;
            silver_gold)
              echo "Executando camadas SILVER e GOLD..."
              python main.py silver_gold
              ;;
            full|*)
              echo "Executando pipeline completo (RAW -> SILVER -> GOLD)..."
              python main.py
              ;;
          esac

      - name: Upload logs em caso de erro
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: pipeline-logs-${{ github.run_id }}
          path: |
            *.log
            logs/
          retention-days: 7

      - name: Notificar sucesso
        if: success()
        run: |
          echo "✅ Pipeline executado com sucesso!"
